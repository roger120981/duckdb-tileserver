name: Build and Push Docker Image

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.repository == 'tobilg/duckdb-tileserver'
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.6'

    - name: Run tests
      run: go test -v ./internal/conf ./internal/data ./internal/service

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.repository == 'tobilg/duckdb-tileserver'
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Derive version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # Extract version from tag (v1.2.3 -> 1.2.3)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_release=true" >> $GITHUB_OUTPUT
        else
          # Use 'latest' for main branch
          echo "version=latest" >> $GITHUB_OUTPUT
          echo "is_release=false" >> $GITHUB_OUTPUT
        fi

    - name: Build ${{ matrix.arch }}
      run: make APPVERSION=${{ steps.version.outputs.version }} TARGETARCH=${{ matrix.arch }} multi-stage-docker

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push ${{ matrix.arch }} image
      env:
        DOCKER_REPO: tobilg/duckdb-tileserver
      run: docker push --all-tags $DOCKER_REPO

  manifest:
    name: Create and Push Manifests
    runs-on: ubuntu-latest
    needs: build
    if: github.repository == 'tobilg/duckdb-tileserver'
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Derive version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # Extract version from tag (v1.2.3 -> 1.2.3)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_release=true" >> $GITHUB_OUTPUT
        else
          # Use 'latest' for main branch
          echo "version=latest" >> $GITHUB_OUTPUT
          echo "is_release=false" >> $GITHUB_OUTPUT
        fi

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Create and push manifests
      env:
        DOCKER_REPO: tobilg/duckdb-tileserver
        VERSION: ${{ steps.version.outputs.version }}
        IS_RELEASE: ${{ steps.version.outputs.is_release }}
      run: |
        if [[ "$IS_RELEASE" == "true" ]]; then
          # For tagged releases: create version and latest manifests
          echo "Creating manifests for release version: $VERSION"

          # Create and push version-specific manifest (e.g., 1.2.3)
          docker manifest create $DOCKER_REPO:$VERSION \
            $DOCKER_REPO:$VERSION-amd64 \
            $DOCKER_REPO:$VERSION-arm64
          docker manifest push $DOCKER_REPO:$VERSION

          # Also update latest
          docker manifest create $DOCKER_REPO:latest \
            $DOCKER_REPO:$VERSION-amd64 \
            $DOCKER_REPO:$VERSION-arm64
          docker manifest push $DOCKER_REPO:latest
        else
          # For main branch: create latest and date-tagged manifests
          echo "Creating manifests for main branch"

          # Create and push latest manifest
          docker manifest create $DOCKER_REPO:latest \
            $DOCKER_REPO:latest-amd64 \
            $DOCKER_REPO:latest-arm64
          docker manifest push $DOCKER_REPO:latest

          # Create and push date-tagged manifest
          date_tag=$(date +%Y%m%d)
          docker manifest create $DOCKER_REPO:${date_tag} \
            $DOCKER_REPO:${date_tag}-amd64 \
            $DOCKER_REPO:${date_tag}-arm64
          docker manifest push $DOCKER_REPO:${date_tag}
        fi
